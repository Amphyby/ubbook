# Что такое неопределенное поведение и как оно проявляется

Неопределенное поведение (undefined behavior, UB) это удивительная особенность некоторых языков программирования,
позволяющая написать синтаксически корректную программу, работающую совершенно непредсказуемо при переносе ее с одной платформы на другую, изменении опций компиляции/интерпретации, и замене одного компилятора/интерпретатора другим. И главное — помимо синтаксической корректности, программа **выглядит** корректной семантически.

Состоит эта особенность в том, что в спецификации языка программирования сознательно
не определяют поведение программы в каких-то особых условиях. Делается это из соображений производительности: не надо генерировать дополнительные инструкции с проверками. Или из соображений обеспечения гибкости при реализации каких-то фич.
В спецификации пишут просто: «Если код делает что-то нехорошее, то поведение не определено». Например:
- Если обратиться по нулевому указателю, поведение не определено.
- Если дважды захватить блокировку в одном и том же потоке, поведение не определено.
- Если поделить на ноль, поведение не определено.
- Если прочитать неинициализированную память, поведение не определено.
- И так далее, и тому подобное.

Важно, что это «поведение не определено» означает, что произойти может что угодно: форматирование диска, ошибка компиляции, исключение, а может и все будет хорошо. Никаких гарантий не дается. Отсюда и происходят веселые, неожиданне и очень печальные
в production-коде последствия.

И, конечно же, именно C и C++ наболее печально известны своим неопределенным поведением.
Однако надо понимать, что эта особенность присуща и другим языкам. Во многих языках можно найти какой-нибудь редкий особенный пример с неопределенным поведением. Но именно в C и C++ оно встречается при написании почти любой программы. Слишком много фич языка содержат пункты с неопределенным поведением.

----

И так, по каким же признакам можно заподозрить UB в программе и насколько неопределенное поведение дествительно неопределенное?

Когда-то давно UB в коде могло повлечь действительно что угодно. Например, `gcc 1.17` [начинал запускать игрушечки](https://feross.org/gcc-ownage/).

Сегодня, если вы поделите что-то на ноль, подобного почти наверное не произойдет. Однако неприятности все же бывают разные:

1. Для данной конкретной платформы и компилятора в документации сказано что именно произойдет, несмотря на страшные слова «_undefined behavior_» в стандарте. И все будет хорошо. Вы знаете что делаете. Никакой неопределенности. Все классно.
2. UB при работе с памятью чаще всего заканчиваются ошибкой сегментации и получением прекрасного сигнала SIGSEGV от операционной системы. Программа падает.
3. Программа работает и штатно завершается. Но дает разные или неадекватные результаты от запуска к запуску. Также результаты меняются от сборки к сборке при изменении опций компилятора или самого компилятора. Никаких генераторов случайных чисел вы не использовали.
4. Программа ведет себя неправильно, несмотря на то, что в коде наставлено огромное множество проверок, `assert`'ов, `try-catch` блоков, каждый из которых «подтвержает» что все корректно. В отладчике видно, что вычисления идут корректно, но совершенно внезапно все ломается.
5. Программа выполняет код, который в ней есть, но не вызывался. Отрабатывают ни разу не вызываемые функции.
6. Компилятор «без причины» и без падаения отказывается собирать код. Линковщик выдает «невозможные и бессмысленные» ошибки.
7. Проверки в коде перестают исполняться. Под отладчиком видно, что исполнение не заходит внутрь веток `if` или `catch`, хотя по значениям переменных заход должен быть выполнен.
8. Внезапный необоснованный вызов `std::terminate`.
9. Бесконечные циклы становятся конечными и наоборот.

---

С неопределенным поведением часто путают два других понятия.
1. Еще одна страшная аббревиатура UB — неуточненное (_unspecified_) поведение. Стандарт не уточняет, что именно может произойти, но описывает варианты. Так, например, порядок вычисления аргуметов фунции — поведение неуточненное.
2. Поведение, определяемое реализацией (_implementation-defined_) — надо смотреть документацию для вашей платформы и вашего компилятора.

Эта парочка намного лучше неопределенного, хотя и имеет с ним одну общую черту: программа, полагающаяся на любое из них, вообще говоря, непереносима.

## Полезные ссылки
1. https://stackoverflow.com/questions/2397984/undefined-unspecified-and-implementation-defined-behavior